<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cy.mapper.BackdownMapper">
    <select id="listBackdownVo" resultType="com.cy.vo.BackdownVo">
        select
        bdn.id,
        bdn.remarks,
        bdn.is_deleted,
        bdn.customer_id,
        bdn.retreattime,
        bdn.retreattype,
        bdn.retreatreason,
        bdn.auditstatus,
        bdn.auditperson,
        bdn.audittime,
        cs.checkin_date,
        cs.bed_id,
        cs.customer_name,
        bdd.bed_details  <!-- 恢复原始字段，若需保留bed_details -->
        from backdown bdn
        join customer cs on cs.id = bdn.customer_id
        left join beddetails bdd on bdd.customer_id = bdn.customer_id  <!-- 左连接床位表 -->
        left join user u on cs.user_id = u.id  <!-- 左连接用户表（关键修改） -->
        where bdn.is_deleted = 0
        <if test="customerId != null">
            and bdn.customer_id = #{customerId}
        </if>
        <if test="userId !=null and userId !=''">
            and u.id = #{userId}
        </if>
        limit #{currentPage},#{pageSize}
    </select>

    <select id="countBackdown" resultType="com.cy.vo.CountVo">
        select
        count(*) as count
        from backdown bdn
        join customer cs on cs.id = bdn.customer_id
        left join beddetails bdd on bdd.customer_id = bdn.customer_id  <!-- 左连接床位表 -->
        left join user u on cs.user_id = u.id  <!-- 左连接用户表（关键修改） -->
        where bdn.is_deleted = 0
        <if test="customerId != null">
            and bdn.customer_id = #{customerId}
        </if>
        <if test="userId !=null and userId !=''">
            and u.id = #{userId}
        </if>
    </select>
</mapper>
        <!--<?xml version="1.0" encoding="UTF-8"?>-->
        <!--<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">-->
        <!--<mapper namespace="com.cy.mapper.BackdownMapper">-->
        <!--    <select id="listBackdownVo" resultType="com.cy.vo.BackdownVo">-->
        <!--        select-->
        <!--            bdn.id,-->
        <!--            bdn.remarks,-->
        <!--            bdn.is_deleted,-->
        <!--            bdn.customer_id,-->
        <!--            bdn.retreattime,-->
        <!--            bdn.retreattype,-->
        <!--            bdn.retreatreason,-->
        <!--            bdn.auditstatus,-->
        <!--            bdn.auditperson,-->
        <!--            bdn.audittime,-->
        <!--            bdd.bed_details,-->
        <!--            cs.checkin_date,-->
        <!--            cs.bed_id,-->
        <!--            cs.customer_name-->
        <!--        from backdown bdn,customer cs ,beddetails bdd,user u-->
        <!--        where cs.user_id = u.id-->
        <!--          and bdn.customer_id = bdd.customer_id-->
        <!--          and cs.id=bdn.customer_id-->
        <!--&#45;&#45;           and bdd.bed_id = cs.bed_id-->
        <!--          and bdn.is_deleted = 0-->
        <!--        <if test="customerId != null">  &lt;!&ndash; 新增客户ID过滤 &ndash;&gt;-->
        <!--            and bdn.customer_id = #{customerId}-->
        <!--        </if>-->
        <!--          <if test="userId !=null and userId !=''">-->
        <!--              and u.id = #{userId}-->
        <!--          </if>-->
        <!--          limit #{currentPage},#{pageSize}-->
        <!--    </select>-->

        <!--    <select id="countBackdown" resultType="com.cy.vo.CountVo">-->
        <!--        select-->
        <!--        distinct count(*) as count-->
        <!--        from backdown bdn,customer cs ,beddetails bdd,user u-->
        <!--        where cs.user_id = u.id-->
        <!--        and cs.id=bdn.customer_id-->
        <!--        and bdn.customer_id = bdd.customer_id-->
        <!--&#45;&#45;         and bdd.bed_id = cs.bed_id-->
        <!--        and bdn.is_deleted = 0-->
        <!--        <if test="customerId != null">  &lt;!&ndash; 新增客户ID过滤 &ndash;&gt;-->
        <!--            and bdn.customer_id = #{customerId}-->
        <!--        </if>-->
        <!--        <if test="userId !=null and userId !=''">-->
        <!--            and u.id = #{userId}-->
        <!--        </if>-->
        <!--    </select>-->
        <!--</mapper>-->